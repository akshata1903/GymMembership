<h2>Members</h2>

@if (role === 'Admin') {
<div class="add-btn-wrapper">
  <button type="button" (click)="toggleAddForm()">Add Member</button>
</div>
}

@if (showAddForm() || editingMember()) {
<div class="modal-overlay" (click)="closeForm()">

  <!-- ================= ADD MEMBER ================= -->
  @if (showAddForm()) {
  <form class="modal-form"
        #addForm="ngForm"
        (ngSubmit)="addMember(addForm)"
        (click)="$event.stopPropagation()">

    <h3>Add Member</h3>

    <div class="form-field">
      <label>Name</label>
      <input name="Name" [(ngModel)]="newMember.Name" required />
    </div>

    <div class="form-field">
      <label>Gender</label>
      <select name="Gender" [(ngModel)]="newMember.Gender" required>
        <option value="">Select Gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
      </select>
    </div>

    <div class="form-field">
      <label>Age</label>
      <input name="Age" type="number" [(ngModel)]="newMember.Age" required />
    </div>

    <div class="form-field">
      <label>Date of Birth</label>
      <input name="DateOfBirth" type="date" [(ngModel)]="newMember.DateOfBirth" />
    </div>

    <div class="form-field">
      <label>Contact Number</label>
      <input name="ContactNumber" [(ngModel)]="newMember.ContactNumber" required />
    </div>

    <div class="form-field">
      <label>Email</label>
      <input name="Email" type="email" [(ngModel)]="newMember.Email" required />
    </div>

    <div class="form-field full-width">
      <label>Address</label>
      <input name="Address" [(ngModel)]="newMember.Address" required />
    </div>

    <div class="form-field">
      <label>Height (feet)</label>
      <input name="Height" type="number"
             [(ngModel)]="newMember.Height"
             (ngModelChange)="calculateBMIForNewMember()" />
    </div>

    <div class="form-field">
      <label>Weight (kg)</label>
      <input name="Weight" type="number"
             [(ngModel)]="newMember.Weight"
             (ngModelChange)="calculateBMIForNewMember()" />
    </div>

    <div class="form-field">
      <label>BMI</label>
      <input name="BMI" type="number" [(ngModel)]="newMember.BMI" readonly />
    </div>

    <div class="form-field full-width">
      <label>Medical Conditions</label>
      <input name="MedicalConditions" [(ngModel)]="newMember.MedicalConditions" />
    </div>

    <div class="form-field full-width">
      <label>Fitness Goals</label>
      <input name="FitnessGoals" [(ngModel)]="newMember.FitnessGoals" />
    </div>

    <div class="form-field">
      <label>Join Date</label>
      <input name="JoinDate" type="date" [(ngModel)]="newMember.JoinDate" />
    </div>

    <div class="form-field">
      <label>Membership End Date</label>
      <input name="MembershipEndDate" type="date"
             [(ngModel)]="newMember.MembershipEndDate" />
    </div>

    <div class="form-field">
      <label>Membership Plan</label>
      <select name="MembershipPlanId"
              [(ngModel)]="newMember.MembershipPlanId" required>
        <option value="">Select Membership Plan</option>
        @for (plan of membershipPlans(); track plan.MembershipPlanId) {
        <option [value]="plan.MembershipPlanId">{{ plan.PlanName }}</option>
        }
      </select>
    </div>

    <div class="form-field">
      <label>Trainer</label>
      <select name="TrainerId" [(ngModel)]="newMember.TrainerId">
        <option value="">Assign Trainer (Optional)</option>
        @for (trainer of trainers(); track trainer.TrainerID) {
        <option [value]="trainer.TrainerID">
          {{ trainer.Name }} ({{ trainer.Specialization }})
        </option>
        }
      </select>
    </div>

    <button type="submit">Save</button>
    <button type="button" (click)="closeForm()">Cancel</button>
  </form>
  }

  <!-- ================= EDIT MEMBER ================= -->
  @if (editingMember()) {
  <form class="modal-form"
        #editForm="ngForm"
        (ngSubmit)="updateMember(editForm)"
        (click)="$event.stopPropagation()">

    <h3>Edit Member</h3>

    <div class="form-field">
      <label>Name</label>
      <input name="Name" [(ngModel)]="editingMember()!.Name" required />
    </div>

    <div class="form-field">
      <label>Gender</label>
      <select name="Gender" [(ngModel)]="editingMember()!.Gender" required>
        <option value="">Select Gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
      </select>
    </div>

    <div class="form-field">
      <label>Age</label>
      <input name="Age" type="number" [(ngModel)]="editingMember()!.Age" required />
    </div>

    <div class="form-field">
      <label>Contact Number</label>
      <input name="ContactNumber" [(ngModel)]="editingMember()!.ContactNumber" required />
    </div>

    <div class="form-field">
      <label>Email</label>
      <input name="Email" type="email" [(ngModel)]="editingMember()!.Email" required />
    </div>

    <div class="form-field full-width">
      <label>Address</label>
      <input name="Address" [(ngModel)]="editingMember()!.Address" required />
    </div>

    <div class="form-field">
      <label>Height (feet)</label>
      <input name="Height" type="number"
             [(ngModel)]="editingMember()!.Height"
             (ngModelChange)="calculateBMIForEditingMember()" />
    </div>

    <div class="form-field">
      <label>Weight (kg)</label>
      <input name="Weight" type="number"
             [(ngModel)]="editingMember()!.Weight"
             (ngModelChange)="calculateBMIForEditingMember()" />
    </div>

    <div class="form-field">
      <label>BMI</label>
      <input name="BMI" type="number" [(ngModel)]="editingMember()!.BMI" readonly />
    </div>

    <div class="form-field full-width">
      <label>Medical Conditions</label>
      <input name="MedicalConditions"
             [(ngModel)]="editingMember()!.MedicalConditions" />
    </div>

    <div class="form-field full-width">
      <label>Fitness Goals</label>
      <input name="FitnessGoals"
             [(ngModel)]="editingMember()!.FitnessGoals" />
    </div>

    <div class="form-field">
      <label>Join Date</label>
      <input name="JoinDate" type="date" [(ngModel)]="editingMember()!.JoinDate" />
    </div>

    <div class="form-field">
      <label>Membership End Date</label>
      <input name="MembershipEndDate" type="date"
             [(ngModel)]="editingMember()!.MembershipEndDate" />
    </div>

    <div class="form-field">
      <label>Membership Plan</label>
      <select name="MembershipPlanId"
              [(ngModel)]="editingMember()!.MembershipPlanId" required>
        <option value="">Select Membership Plan</option>
        @for (plan of membershipPlans(); track plan.MembershipPlanId) {
        <option [value]="plan.MembershipPlanId">{{ plan.PlanName }}</option>
        }
      </select>
    </div>

    <div class="form-field">
      <label>Trainer</label>
      <select name="TrainerId" [(ngModel)]="editingMember()!.TrainerId">
        <option value="">Assign Trainer (Optional)</option>
        @for (trainer of trainers(); track trainer.TrainerID) {
        <option [value]="trainer.TrainerID">
          {{ trainer.Name }} ({{ trainer.Specialization }})
        </option>
        }
      </select>
    </div>

    <button type="submit">Update</button>
    <button type="button" (click)="closeForm()">Cancel</button>
  </form>
  }

</div>
}

<hr />

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Name</th>
      <th>Gender</th>
      <th>Age</th>
      <th>DOB</th>
      <th>Contact</th>
      <th>Email</th>
      <th>Address</th>
      <th>Height</th>
      <th>Weight</th>
      <th>BMI</th>
      <th>Medical</th>
      <th>Goals</th>
      <th>Join Date</th>
      <th>End Date</th>
      <th>Status</th>
      <th>Plan</th>
      <th>Trainer</th>
      <th>Actions</th>
    </tr>
  </thead>

  <tbody>
    @for (member of members(); track member.MemberID) {
    <tr>
      <td>{{ member.MemberID }}</td>
      <td>{{ member.Name }}</td>
      <td>{{ member.Gender }}</td>
      <td>{{ member.Age }}</td>
      <td>{{ member.DateOfBirth | date }}</td>
      <td>{{ member.ContactNumber }}</td>
      <td>{{ member.Email }}</td>
      <td>{{ member.Address }}</td>
      <td>{{ member.Height }}</td>
      <td>{{ member.Weight }}</td>
      <td>{{ member.BMI }}</td>
      <td>{{ member.MedicalConditions }}</td>
      <td>{{ member.FitnessGoals }}</td>
      <td>{{ member.JoinDate | date }}</td>
      <td>{{ member.MembershipEndDate | date }}</td>

      <td>
  <span class="status" [class.active]="member.IsActive">
    {{ member.IsActive ? 'Active' : 'Inactive' }}
  </span>
</td>

      <td>{{ getPlanName(member.MembershipPlanId) }}</td>
      <td>{{ getTrainerName(member.TrainerId) }}</td>

      <td>
        <button (click)="editMember(member)" [disabled]="!member.IsActive">
          Edit
        </button>

        @if (role === 'Admin') {
        <button (click)="deleteMember(member.MemberID)">Delete</button>
        }
      </td>
    </tr>
    }
  </tbody>
</table>